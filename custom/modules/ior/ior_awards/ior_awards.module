<?php

/**
 * @file
 * Contains ior_awards.module.
 */

/**
 * Implements hook_theme().
 */
function ior_awards_theme($existing, $type, $theme, $path) {
  return [
    'page_title__ior_submission' => [
      'base hook' => 'page_title',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function ior_awards_theme_suggestions_page_title(array $variables) {
  $suggestions = [];
  if (_get_submission_from_route()) {
    $suggestions[] = 'page_title__ior_submission';
  }
  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function ior_awards_preprocess_page_title(array &$variables) {
  if ($submission = _get_submission_from_route()) {
    $awards = _award_storage()->loadBySubmission($submission->id());
    foreach ($awards as $award) {
      $award_variables = [
        'field_type' => $award
          ->get('field_type')
          ->view('default'),
      ];
      $variables['awards'][$award->getTypeId()] = $award_variables;
    }
  }

}

/**
 * Load a submission entity from the current route.
 *
 * @return \Drupal\ior\Entity\SubmissionInterface|false
 *   A submission entity. False if the current route does not contain a
 *   parameter that resolves to a submission entity.
 */
function _get_submission_from_route() {
  $route_match = Drupal::routeMatch();
  if ($route_match->getRouteName() !== 'entity.ior_submission.canonical') {
    return FALSE;
  }

  /** @var \Drupal\ior\Entity\SubmissionInterface $submission */
  if ($submission = $route_match->getParameter('ior_submission')) {
    return $submission;
  }
  return FALSE;
}

/**
 * Get the IOR award storage.
 *
 * @return \Drupal\ior_awards\Entity\Storage\AwardStorageInterface
 *   A storage handler for IOR award entities.
 */
function _award_storage() {
  /** @var \Drupal\ior_awards\Entity\Storage\AwardStorageInterface $award_storage */
  $award_storage = Drupal::entityTypeManager()->getStorage('ior_award');
  return $award_storage;
}
